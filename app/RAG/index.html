<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Sales RAG UI (min)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; max-width: 920px; margin: 24px auto; }
    h1 { margin-bottom: 8px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .col { flex: 1 1 420px; min-width: 320px; }
    textarea, input, button { width: 100%; padding: 8px; }
    textarea { min-height: 140px; }
    pre, code { background: #f6f8fa; padding: 8px; border-radius: 6px; overflow:auto; }
    .out { white-space: pre-wrap; }
    .ok { color: #176c2b; }
    .err { color: #a40000; }
    .tiny { font-size: 12px; color: #666; }
    .box { border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 16px; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
  <h1>Sales RAG ‚Äî UI minimale</h1>
  <div class="box">
    <label>API base URL (FastAPI):</label>
    <input id="apiBase" value="http://localhost:8080" />
    <div class="tiny">Assicurati che il backend sia attivo: <span class="kbd">uvicorn src.apps:app --reload --port 8080</span></div>
  </div>

  <div class="row">
    <div class="col box">
      <h2>1) Ingest</h2>
      <label>Session ID</label>
      <input id="sessionIdIngest" placeholder="es. vale-123" />
      <label>Testi (uno per riga: email, messaggi, note, offerte)</label>
      <textarea id="docs" placeholder="Email: budget 25k, preferisce automatica...
Offerta: 27.4k DSG, consegna 2 settimane...
WhatsApp: vuole rata &lt; 300‚Ç¨/mese..."></textarea>
      <label><input type="checkbox" id="clear" /> resetta sessione</label>
      <button id="btnIngest">Invia a /ingest</button>
      <div id="ingestOut" class="out tiny"></div>
    </div>

    <div class="col box">
      <h2>2) Chat</h2>
      <label>Session ID</label>
      <input id="sessionIdChat" placeholder="stesso session id di sopra" />
      <label>Domanda / riassunto venditore</label>
      <textarea id="question" placeholder="Ha detto che la rata √® alta e vuole gomme invernali incluse."></textarea>
      <button id="btnChat">Chiedi a /chat</button>
      <div id="chatStatus" class="out"></div>
      <h3>JSON (insight)</h3>
      <pre id="jsonOut"></pre>
      <h3>Recap (Markdown grezzo)</h3>
      <pre id="mdOut"></pre>
    </div>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);

    async function postJSON(url, body) {
      const r = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      const text = await r.text();
      try { return { ok: r.ok, data: JSON.parse(text) }; }
      catch { return { ok: r.ok, data: text }; }
    }

    $("#btnIngest").onclick = async () => {
      const base = $("#apiBase").value.trim().replace(/\/+$/,'');
      const sid = $("#sessionIdIngest").value.trim();
      const clear = $("#clear").checked ? "&clear=true" : "";
      const docsRaw = $("#docs").value.split("\n").map(s => s.trim()).filter(Boolean);

      if (!sid) { $("#ingestOut").innerHTML = '‚ö†Ô∏è manca session_id'; return; }
      if (!docsRaw.length) { $("#ingestOut").innerHTML = '‚ö†Ô∏è nessun testo valido'; return; }

      const url = `${base}/ingest?session_id=${encodeURIComponent(sid)}${clear}`;
      const res = await postJSON(url, docsRaw);

      $("#ingestOut").innerHTML = res.ok
        ? `<span class="ok">OK</span> ${JSON.stringify(res.data)}`
        : `<span class="err">ERRORE</span> ${typeof res.data==='string'?res.data:JSON.stringify(res.data)}`;
    };

    $("#btnChat").onclick = async () => {
      const base = $("#apiBase").value.trim().replace(/\/+$/,'');
      const sid = $("#sessionIdChat").value.trim();
      const q = $("#question").value.trim();

      $("#jsonOut").textContent = "";
      $("#mdOut").textContent = "";
      $("#chatStatus").textContent = "";

      if (!sid) { $("#chatStatus").innerHTML = '‚ö†Ô∏è manca session_id'; return; }
      if (!q) { $("#chatStatus").innerHTML = '‚ö†Ô∏è domanda vuota'; return; }

      const url = `${base}/chat?session_id=${encodeURIComponent(sid)}`;
      const res = await postJSON(url, q);

      if (!res.ok) {
        $("#chatStatus").innerHTML = `<span class="err">ERRORE</span> ${typeof res.data==='string'?res.data:JSON.stringify(res.data)}`;
        return;
      }

      if (res.data && res.data.blocked) {
        $("#chatStatus").innerHTML = `üö´ Richiesta bloccata: ${res.data.message}`;
        return;
      }
      if (res.data && res.data.error) {
        $("#chatStatus").innerHTML = `‚ö†Ô∏è ${res.data.error}`;
        return;
      }

      $("#chatStatus").innerHTML = `<span class="ok">OK</span> risposta ricevuta`;
      if (res.data && res.data.json) {
        $("#jsonOut").textContent = JSON.stringify(res.data.json, null, 2);
      }
      if (res.data && res.data.raw_text) {
        $("#mdOut").textContent = res.data.raw_text;
      }
    };
  </script>
</body>
</html>
